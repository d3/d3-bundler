#!/usr/bin/env node

var path = require("path"),
    minimist = require("minimist"),
    rollup = require("rollup");

var polyfill = {
  "requestAnimationFrame":
      'if (typeof requestAnimationFrame === "undefined") {\n' +
      '  requestAnimationFrame = typeof window !== "undefined"\n' +
      '      && (window.msRequestAnimationFrame\n' +
      '      || window.mozRequestAnimationFrame\n' +
      '      || window.webkitRequestAnimationFrame\n' +
      '      || window.oRequestAnimationFrame)\n' +
      '      || function(callback) { setTimeout(callback, 17); };\n' +
      '}\n' +
      '\n',
  "Map":
      'if (typeof Map === "undefined") {\n' +
      '  Map = function() {};\n' +
      '  Map.prototype = {\n' +
      '    set: function(k, v) { this["$" + k] = v; return this; },\n' +
      '    get: function(k) { return this["$" + k]; },\n' +
      '    has: function(k) { return "$" + k in this; }\n' +
      '  };\n' +
      '}\n' +
      '\n'
};

var argv = minimist(process.argv.slice(2)),
    entry = argv._[0],
    name = argv.name || "d3",
    format = argv.format || "umd";

rollup.rollup({
  entry: entry,
  resolvePath: function(importee, importer, options) {
    return /^\./.test(importee)
        ? path.resolve(path.dirname(importer), importee).replace(/\.js$/, "") + ".js"
        : path.join("node_modules", importee, "index.js");
  }
}).then(function(bundle) {
  if (argv["polyfill"] || argv["polyfill-map"]) process.stdout.write(polyfill.Map);
  if (argv["polyfill"] || argv["polyfill-raf"]) process.stdout.write(polyfill.requestAnimationFrame);
  process.stdout.write(bundle.generate({format: format, moduleName: name}).code);
}).catch(function(error) {
  console.error(error);
});
